#!/bin/bash
set -u

TIMEOUT=900
CACHE_FILE="/tmp/aws_credentials_$(echo "$*" | md5)"

# Clean up expired cache files
for cache in /tmp/aws_credentials_*; do
    [[ -f "$cache" ]] || continue
    AGE=$(($(date +%s) - $(stat -f %m "$cache")))
    [[ $AGE -gt $TIMEOUT ]] && rm "$cache"
done

# Add defaults if not already provided
args=()
[[ "$*" != *"--account"* && -n "${AWS_ACCOUNT_ID:-}" ]] && args+=(--account "$AWS_ACCOUNT_ID")
[[ "$*" != *"--role"* ]] && args+=(--role "${AWS_ACCOUNT_ROLE:-Admin}")
args+=("$@")

# Check cache
if [[ -f "$CACHE_FILE" ]]; then
    AGE=$(($(date +%s) - $(stat -f %m "$CACHE_FILE")))
    if [[ $AGE -le $TIMEOUT ]]; then
        cat "$CACHE_FILE"
        exit 0
    fi
fi

# Get fresh credentials
CREDENTIALS=$(ada credentials print "${args[@]}")
if [[ $? -eq 0 ]]; then
    echo "$CREDENTIALS" | tee "$CACHE_FILE"
else
    echo "$CREDENTIALS" >&2
    exit 1
fi

